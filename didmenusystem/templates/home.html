{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}

{% if user.is_authenticated %}
    {% if filter_selection == "split_by_carrier" %}
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th colspan="7" class="text-center">{{carrier1}}</th>
                    <th colspan="1"></th>
                    <th colspan="7" class="text-center">{{carrier2}}</th>
                </tr>
                <tr>
                    <th scope="col">PseudoCID</th>
                    <th scope="col">Client Description</th>
                    <th scope="col">Sales Type</th>
                    <th scope="col">Date Usage</th>
                    <th scope="col">Purchase Date</th>
                    <th scope="col">DID Count</th>
                    <th scope="col">Carrier</th>
                    <th colspan="1"></th>
                    <th scope="col">PseudoCID</th>
                    <th scope="col">Client Description</th>
                    <th scope="col">Sales Type</th>
                    <th scope="col">Date Usage</th>
                    <th scope="col">Purchase Date</th>
                    <th scope="col">DID Count</th>
                    <th scope="col">Carrier</th>
                </tr>
            </thead>
            <tbody>
                {% for record_pair in combined_records %}
                    {% with record_C1=record_pair.0 record_C2=record_pair.1 %}
                        <tr>
                            <td>{% if record_C1 %}<a href="{% url 'pseudoCID' record_C1.PseudoCID %}">{{ record_C1.PseudoCID }}</a>{% endif %}</td>
                            <td>{% if record_C1 %}{{ record_C1.Client_Description }}{% endif %}</td>  
                            <td>{% if record_C1 %}{{ record_C1.Sales_Type }}{% endif %}</td>
                            <td>{% if record_C1 %}<a href="{% url 'edit_lastuse_date' record_C1.PseudoCID %}">{{ record_C1.LastUse_Date }}</a>{% endif %}</td>
                            <td>{% if record_C1 %}{{ record_C1.PR_Date }}{% endif %}</td>                        
                            <td>{% if record_C1 %}{{ record_C1.DID_CNT }}{% endif %}</td>                        
                            <td>{% if record_C1 %}{{ record_C1.Carrier }}{% endif %}</td>                        
                            <th></th>
                            <td>{% if record_C2 %}<a href="{% url 'pseudoCID' record_C2.PseudoCID %}">{{ record_C2.PseudoCID }}</a>{% endif %}</td>                        
                            <td>{% if record_C2 %}{{ record_C2.Client_Description }}{% endif %}</td>
                            <td>{% if record_C2 %}{{ record_C2.Sales_Type }}{% endif %}</td>
                            <td>{% if record_C2 %}<a href="{% url 'edit_lastuse_date' record_C2.PseudoCID %}">{{ record_C2.LastUse_Date }}</a>{% endif %}</td>                                                
                            <td>{% if record_C2 %}{{ record_C2.PR_Date }}{% endif %}</td>
                            <td>{% if record_C2 %}{{ record_C2.DID_CNT }}{% endif %}</td>                        
                            <td>{% if record_C2 %}{{ record_C2.Carrier }}{% endif %}</td>
                        </tr>
                    {% endwith %}                        
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th scope="col">PseudoCID</th>
                    <th scope="col">Client Description</th>
                    <th scope="col">Sales Type</th>
                    <th scope="col">Carrier</th>
                    <th scope="col">Status</th>
                    <th scope="col">Date Usage</th>                    
                    <th scope="col">Purchase Date</th>
                    <th scope="col">DID Count</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                    <tr>
                        <td><a href="{% url 'pseudoCID' record.PseudoCID %}">{{ record.PseudoCID }}</a></td>
                        <td>{{ record.Client_Description }}</td>
                        <td>{{ record.Sales_Type }}</td>
                        <td>{{ record.Carrier }}</td>
                        <td>{{ record.Status }}</td>
                        <td><a href="{% url 'edit_lastuse_date' record.PseudoCID %}">{{ record.LastUse_Date }}</a></td>
                        <td>{{ record.PR_Date }}</td>
                        <td>{{ record.DID_CNT }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
    <form method="post" action="{% url 'ExportCSV' %}" class="d-inline">
        {% csrf_token %}

        <input type="hidden" name="combined_records_json" value="{{ combined_records_json }}">
                
        <a href="{% url 'home' %}" class="btn btn-secondary">Back</a>
        <input type="hidden" name="records_json" value="{{ records_json }}">        
        <button type="submit" class="btn btn-success">Download Data to CSV</button>
    </form>
{% else %}
    <div class="col-md-6 offset-md-3">
        <h1>Login</h1>
        <br/>
        <form method="POST" action="{% url 'home' %}">
            {% csrf_token %}
            <div class="mb-3">
                <input type="text" class="form-control" name="username", placeholder="Username", required>
            </div>
            <br/>
            <div class="mb-3">
                <input type="password" class="form-control", name="password", placeholder="Password", required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
    </div>
{% endif %}

{% endblock %}